name: OpenFAST Windows

on:
  workflow_dispatch:

jobs:
  build-windows-executables:
    runs-on: windows-2022

    steps:
      # Checkout
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      # Ensure VS environment works
      - name: Test devenv
        shell: cmd
        run: .github/scripts/windows_devenv_test.bat

      # Install Intel Fortran (official upstream method)
      - name: Install Intel Fortran Essentials
        shell: cmd
        env:
          URL: https://registrationcenter-download.intel.com/akdlm/IRC_NAS/33676fcf-14a3-4e96-a9b9-72976b1145d9/intel-fortran-essentials-2025.3.1.25_offline.exe
        run: |
          curl.exe --output %TEMP%\intel.exe --url %URL% --retry 5 --retry-delay 5
          %TEMP%\intel.exe -s -a --silent --eula accept -p=NEED_VS2022_INTEGRATION=1 --log-dir=.
          exit /b %ERRORLEVEL%

      # Clean build folder
      - name: Clean build
        shell: cmd
        run: |
          if exist build rmdir /s /q build

      # Build executables (OFFICIAL upstream script)
      - name: Build executables
        shell: cmd
        run: .github/scripts/build_windows_executables.bat

      # Verify exe exists
      - name: List output
        shell: cmd
        run: dir build\bin

      # Upload exe + dll only
      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: openfast-windows
          path: |
            build/bin/*.exe
            build/bin/*.dll
